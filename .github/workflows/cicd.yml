name: CI & CD

on:
  push:
    branches: [master]

jobs:
  deploy:
    name: Deploy to NAS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Connect to NAS via SSH - Test Connection
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.NAS_HOST }}
          username: ${{ secrets.NAS_USER }}
          password: ${{ secrets.NAS_PASSWORD }}
          port: ${{ secrets.NAS_PORT }}
          script: echo "âœ… NAS ì ‘ì† ì„±ê³µ"

      - name: Update Git Repository on NAS
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.NAS_HOST }}
          username: ${{ secrets.NAS_USER }}
          password: ${{ secrets.NAS_PASSWORD }}
          port: ${{ secrets.NAS_PORT }}
          script: |
            cd /volume1/docker/monitor
            echo "ğŸŒ€ GitHub master ë¸Œëœì¹˜ ìµœì‹ í™”"
            git fetch origin
            git reset --hard origin/master

      - name: Create .env files on NAS
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.NAS_HOST }}
          username: ${{ secrets.NAS_USER }}
          password: ${{ secrets.NAS_PASSWORD }}
          port: ${{ secrets.NAS_PORT }}
          script: |
            cd /volume1/docker/monitor
            echo "ğŸ“¦ .env íŒŒì¼ ìƒì„± ì‹œì‘"
            rm -f .env

            cat <<EOF > .env
            GF_SECURITY_ADMIN_USER=${{ secrets.GF_SECURITY_ADMIN_USER }}
            GF_SECURITY_ADMIN_PASSWORD=${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
            SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
            EOF

            echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"

      - name: Docker Build, Down, Up on NAS
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.NAS_HOST }}
          username: ${{ secrets.NAS_USER }}
          password: ${{ secrets.NAS_PASSWORD }}
          port: ${{ secrets.NAS_PORT }}
          script: |
            cd /volume1/docker/lottery

            echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ"
            /usr/local/bin/docker-compose build

            echo "ğŸ§¨ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
            /usr/local/bin/docker-compose down

            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            /usr/local/bin/docker-compose up -d

            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ"
